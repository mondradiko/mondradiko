name: vcpkg test - combined

on: [pull_request]

defaults:
  run:
    shell: bash
jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            generator: msbuild
            cc: cl.exe
            cxx: cl.exe
          - os: windows-latest
            generator: ninja
            cc: cl.exe
            cxx: cl.exe
          - os: ubuntu-20.04
            generator: ninja
            cc: gcc-10
            cxx: g++-10
          - os: ubuntu-20.04
            generator: ninja
            cc: clang-10
            cxx: clang++-10
            vcpkg: manual
          - os: ubuntu-16.04
            generator: ninja
            cc: clang-9
            cxx: clang++-9
    runs-on: ${{ matrix.os }}
    env:
      CC: ${{ matrix.cc }}
      CXX: ${{ matrix.cxx }}
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'true'
      - uses: seanmiddleditch/gha-setup-ninja@master

      - name: Setup VsDev environment
        if: runner.os == 'Windows'
        uses: seanmiddleditch/gha-setup-vsdevenv@master

      - name: apt
        if: runner.os == 'Linux'
        run: sudo apt install libwayland-dev libxrandr-dev

      - name: Setup python
        if: matrix.os == 'ubuntu-16.04'
        uses: actions/setup-python@v2
        with:
          python-version: 3.6
          architecture: x64

      - name: setup environment vars
        run: |
             CACHE_KEY=$(echo "${{ matrix.os }}-${{ matrix.cc }}-${{ github.head_ref }}" | tr -cd '[a-zA-Z0-9]._-')
             echo "CACHE_KEY=$CACHE_KEY" | tee -a $GITHUB_ENV
             if [ "${{runner.os}}" == "Linux" ]; then
               echo "ci_vcpkg_cache_dir=/home/runner/.cache/vcpkg" >> $GITHUB_ENV
             else
               echo "ci_vcpkg_cache_dir=$LOCALAPPDATA/vcpkg" >> $GITHUB_ENV
             fi
             mkdir builddir

      # C:\Users\runneradmin\AppData\Local\vcpkg\archives\b2\b296ead7fc7aa1749f15e5cb13d9428ba06ba136.zip
      # /home/runner/.cache/vcpkg/archives/8d/8d792cc1dd8063a65fb68f328990ef4a9ce795f7.zip
      - name: vcpkg binary cache
        uses: actions/cache@v2
        with:
          path: ${{ env.ci_vcpkg_cache_dir }}
          key: ${{ env.CACHE_KEY }}-vcpkg-binarycache4
          restore-keys: ${{ env.CACHE_KEY }}-vcpkg-binarycache3

      # - name: cache -- vcpkg, builddir/vcpkg_installed
      #   uses: actions/cache@v2
      #   with:
      #     path: |
      #       builddir/vcpkg_installed
      #       vcpkg
      #       !vcpkg/buildtrees
      #       !vcpkg/downloads
      #       !vcpkg/packages
      #     key: ${{ env.CACHE_KEY }}-builddir-vcpkg-manifestmode-wvalidation
      #     restore-keys: |
      #       ${{ env.CACHE_KEY }}-builddir-vcpkg-manifestmode
      #       ${{ matrix.os }}-${{ matrix.cc }}-${{ github.head_ref }}-builddir-vcpkg-manifestmode
      #       ${{ matrix.os }}-${{ github.head_ref }}-builddir-vcpkg-manifestmode

      - name: mkdir builddir
        run: |
          test -d builddir || mkdir builddir

      - name: manually install vcpkg dependencies
        if: matrix.vcpkg == 'manual'
        run: |
           echo "USE_VCPKG=OFF" >> $GITHUB_ENV
           git clone --branch v1.8 --single-branch https://github.com/Chlumsky/msdfgen.git lib/msdfgen
           sudo apt install libglm-dev libsdl2-dev liblz4-dev libvulkan-dev \
                 build-essential glslang-tools \
                 libzstd-dev libfreetype6-dev \
                 libprotobuf-dev protobuf-compiler libssl-dev \
                 libgl1-mesa-dev libx11-xcb-dev libxcb-dri2-0-dev \
                 libxcb-glx0-dev libxcb-icccm4-dev libxcb-keysyms1-dev \
                 libxcb-randr0-dev libxrandr-dev libxxf86vm-dev \
                 mesa-common-dev
           ./vcpkg/bootstrap-vcpkg.sh
           ./vcpkg/vcpkg \
                --x-install-root=$PWD/builddir/vcpkg_installed \
                --overlay-ports=$PWD/cmake/vcpkg-ports \
                --overlay-triplets=$PWD/cmake/vcpkg-triplets \
                --triplet=x64-linux \
                install xxhash openxr-loader cli11 wasmtime-prebuilt flatbuffers gamenetworkingsockets

      - name: Build with Ninja
        if: matrix.generator == 'ninja'
        run: |
          pushd builddir
          cmake -GNinja ..
          ninja
          popd
      # - name: Setup tmate session
      #   if: matrix.generator != 'ninja'
      #   uses: mxschmitt/action-tmate@v3
      #   with:
      #     limit-access-to-actor: true
      - name: Build with CMake
        if: matrix.generator != 'ninja'
        run: |
          pushd builddir
          cmake ..
          unset TEMP TMP # these break MSBuild for some reason
          cmake --build . --config release
          ./client/Release/mondradiko-client --version || true
          ./server/Release/mondradiko-server --version || true
          ./bundler/Release/mondradiko-bundler --version || true
          popd
      - name: Verify
        if: matrix.generator == 'ninja'
        run: |
          ./builddir/client/mondradiko-client --version || true
          ./builddir/server/mondradiko-server --version || true
          ./builddir/bundler/mondradiko-bundler --version || true

# jobs:
#     env:
#       USE_VCPKG: ON
#       CC: ${{ matrix.cc }}
#       CXX: ${{ matrix.cxx }}
#     steps:
#       - name: Setup python
#         uses: actions/setup-python@v2
#         with:
#           python-version: 3.6
#           architecture: x64
#       - name: Get software versions please
#         run: |
#           cmake --version
#           ninja --version
#           git --version
#           python --version
#           if [ "$CXX" == "cl.exe" ]; then
#               $CXX
#           else
#               $CXX --version
#           fi
#       # - name: Setup tmate session
#       #   uses: mxschmitt/action-tmate@v3
#       #   with:
#       #     limit-access-to-actor: true
#       - name: Verify
#         run: |
#           echo "ARTIFACT_NAME=`date -u '+%Y%m%d%H%M'`-`echo '${{ matrix.os }}' | sed -e 's/[^A-Za-z0-9]/-/g'`-`echo ${{ github.event.pull_request.head.sha }} | cut -c1-7`" | tee -a $GITHUB_ENV
#           echo "-- ‚õ∑Ô∏è  CLIENT --"
#           [ "${{runner.os}}" == "Linux" ] && ldd builddir/client/mondradiko-client || true
#           ls -lrth builddir/client
#           ./builddir/client/mondradiko-client --version || true
# 
#           echo "-- üé™  SERVER --"
#           [ "${{runner.os}}" == "Linux" ] && ldd builddir/server/mondradiko-server || true
#           ls -lrth builddir/server
#           ./builddir/server/mondradiko-server --version || true
# 
#           echo "-- üõÑ  BUNDLER --"
#           [ "${{runner.os}}" == "Linux" ] && ldd builddir/bundler/mondradiko-bundler || true
#           ls -lrth builddir/bundler
#           ./builddir/bundler/mondradiko-bundler --version || true
# 
#       - name: Upload Artifact
#         if: false
#         uses: actions/upload-artifact@v2
#         with:
#           name: ${{ env.ARTIFACT_NAME }}
#           retention-days: 1
#           path: |
#             builddir/client
#             builddir/server
#             builddir/bundler
#             !builddir/**/*.cmake
#             !builddir/**/CMakeFiles
#             !builddir/**/*.manifest
